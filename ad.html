<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch to Earn</title>
  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; margin:0; background:#0b0f19; color:#fff; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:#111826; border:1px solid #1e293b; border-radius:12px; padding:16px; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    h2 { margin:6px 0 10px; font-weight:600; }
    p { margin:6px 0 12px; color:#cbd5e1; }
    .player { position:relative; width:100%; padding-top:56.25%; border-radius:10px; overflow:hidden; background:#000; }
    .player iframe, .player video { position:absolute; top:0; left:0; width:100%; height:100%; border:0; }
    .actions { margin-top:14px; display:flex; gap:12px; align-items:center; }
    .btn { appearance:none; border:none; padding:12px 18px; border-radius:10px; cursor:not-allowed; background:#334155; color:#cbd5e1; font-weight:600; }
    .btn.enabled { background:#16a34a; color:#fff; cursor:pointer; }
    .timer { margin-left:auto; color:#94a3b8; font-variant-numeric: tabular-nums; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 id="title">Watch to Earn</h2>
      <p id="desc">Watch the video below. The claim button will unlock after the timer finishes.</p>
      <div class="player" id="player"></div>
      <div class="actions">
        <button id="claim" class="btn" disabled>Claim Reward</button>
        <span id="timer" class="timer">...</span>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const qs = new URLSearchParams(location.search);
    const taskId = qs.get('taskId') || '';
    const name = qs.get('name') || 'Ad Task';
    const link = qs.get('link') || '';
    const secondsParam = parseInt(qs.get('seconds') || '30', 10);
    let seconds = isNaN(secondsParam) ? 30 : Math.max(0, secondsParam);

    document.getElementById('title').textContent = 'Watch: ' + name;
    document.getElementById('desc').textContent = seconds > 0
      ? 'Watch the video below. The claim button unlocks after ' + seconds + ' seconds.'
      : 'Watch the video below. Claim is available immediately.';
    document.getElementById('timer').textContent = seconds + 's';

    function isYouTube(u) {
      const l = (u || '').toLowerCase();
      return l.includes('youtube.com/watch') || l.includes('youtu.be/');
    }

    function youtubeEmbedUrl(u) {
      try {
        const lower = u.toLowerCase();
        if (lower.includes('youtu.be/')) {
          const id = u.split('/').pop().split('?')[0];
          return 'https://www.youtube.com/embed/' + id + '?autoplay=1&mute=0';
        }
        const url = new URL(u);
        const id = url.searchParams.get('v') || '';
        return id ? ('https://www.youtube.com/embed/' + id + '?autoplay=1&mute=0') : '';
      } catch { return ''; }
    }

    const player = document.getElementById('player');
    if (isYouTube(link)) {
      const ifr = document.createElement('iframe');
      ifr.src = youtubeEmbedUrl(link);
      ifr.allow = 'autoplay; encrypted-media';
      ifr.allowFullscreen = true;
      player.appendChild(ifr);
    } else if (link) {
      const vid = document.createElement('video');
      vid.controls = true;
      vid.autoplay = true;
      vid.src = link;
      player.appendChild(vid);
    } else {
      const div = document.createElement('div');
      div.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%';
      div.textContent = 'No video link provided';
      player.appendChild(div);
    }

    const claimBtn = document.getElementById('claim');
    let timer = null;

    function enableClaim() {
      claimBtn.classList.add('enabled');
      claimBtn.disabled = false;
      claimBtn.style.cursor = 'pointer';
      if (timer) clearInterval(timer);
    }

    function tick() {
      seconds -= 1;
      document.getElementById('timer').textContent = seconds + 's';
      if (seconds <= 0) enableClaim();
    }

    window.addEventListener('load', () => {
      document.getElementById('timer').textContent = seconds + 's';
      if (seconds <= 0) enableClaim();
      else timer = setInterval(tick, 1000);
    });

    claimBtn.addEventListener('click', () => {
      if (claimBtn.disabled) return;
      const payload = { status: 'watched', taskId: taskId };
      if (tg) {
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } else {
        // Fallback for testing outside Telegram
        alert('Would send to bot: ' + JSON.stringify(payload));
      }
    });
  </script>
</body>
</html>